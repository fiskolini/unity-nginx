# Serve anything inside /br/
location /br/ {
    try_files $uri $uri/ =404;
}

# Serve /br/Build/*
location /br/Build/ {
    add_header Vary Accept-Encoding;
    add_header Content-Encoding br;

    # Rewrite to serve compressed items
    rewrite ^/br/Build/(.*)\.js$ /br/Build/$1.js.br break;
    rewrite ^/br/Build/(.*)\.wasm$ /br/Build/$1.wasm.br break;
    rewrite ^/br/Build/(.*)\.data$ /br/Build/$1.data.br break;
    rewrite ^/br/Build/(.*)\.symbols\.json$ /br/Build/$1.symbols.json.br break;

    try_files $uri =404;

    # MIME types for Unity WebGL assets
    types {
        application/wasm wasm;
        application/javascript js;
        application/octet-stream data;
        application/json json;
        application/wasm br;
    }
}

# Serve specifically .wasm.br files
location ~* ^/br/.*\.wasm\.br$ {
    add_header Content-Encoding br;
    default_type application/wasm;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    try_files $uri =404;
}

# Serve any .br inside /br/ with Content-Encoding br
location ~* ^/br/.*\.br$ {
    add_header Content-Encoding br;
    try_files $uri =404;
}

# Assets Cache
location ~* ^/br/.*\.(js|wasm|data|symbols\.json|framework\.js|loader\.js|bundle\.js|br|gz)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    try_files $uri =404;
}