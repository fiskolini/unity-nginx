# Serve anything inside /gz/
location /gz/ {
    try_files $uri $uri/ =404;
}

# Serve /gz/Build/*
location /gz/Build/ {
    add_header Vary Accept-Encoding;
    add_header Content-Encoding gzip;

    # Rewrite to serve compressed items
    rewrite ^/gz/Build/(.*)\.js$ /gz/Build/$1.js.gz break;
    rewrite ^/gz/Build/(.*)\.wasm$ /gz/Build/$1.wasm.gz break;
    rewrite ^/gz/Build/(.*)\.data$ /gz/Build/$1.data.gz break;
    rewrite ^/gz/Build/(.*)\.symbols\.json$ /gz/Build/$1.symbols.json.gz break;

    try_files $uri =404;

    # MIME types for Unity WebGL assets
    types {
        application/wasm wasm;
        application/javascript js;
        application/octet-stream data;
        application/json json;
        application/wasm gzip;
    }
}

# Serve specifically .wasm.gz files
location ~* ^/gz/.*\.wasm\.gz$ {
    add_header Content-Encoding gzip;
    default_type application/wasm;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    try_files $uri =404;
}

# Serve any .gz inside /gz/ with Content-Encoding gzip
location ~* ^/gz/.*\.gz$ {
    add_header Content-Encoding gzip;
    try_files $uri =404;
}

# Assets Cache
location ~* ^/gz/.*\.(js|wasm|data|symbols\.json|framework\.js|loader\.js|bundle\.js|gz)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    try_files $uri =404;
}